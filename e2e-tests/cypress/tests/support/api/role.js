// Copyright (c) 2015-present Mattermost, Inc. All Rights Reserved.
// See LICENSE.txt for license information.

import xor from 'lodash.xor';

// *****************************************************************************
// Preferences
// https://api.mattermost.com/#tag/roles
// *****************************************************************************

export const defaultRolesPermissions = {
    channel_admin: 'use_channel_mentions delete_others_posts delete_private_channel add_public_channel_members delete_bookmark_private_channel read_private_channel_groups read_public_channel_groups edit_bookmark_private_channel order_bookmark_public_channel create_post manage_public_channel_properties manage_public_channel_members add_bookmark_private_channel edit_bookmark_public_channel manage_private_channel_members delete_bookmark_public_channel delete_public_channel order_bookmark_private_channel add_reaction manage_channel_roles convert_public_channel_to_private add_private_channel_members remove_reaction use_group_mentions manage_private_channel_properties add_bookmark_public_channel',
    channel_guest: 'remove_reaction upload_file edit_post create_post use_channel_mentions read_channel read_channel_content add_reaction',
    channel_readonly: 'read_channel read_channel_content',
    channel_user: 'use_group_mentions read_channel_content get_public_link delete_post add_bookmark_public_channel read_public_channel_groups read_channel read_private_channel_groups edit_post add_public_channel_members add_bookmark_private_channel',
    channel_verified: 'order_bookmark_public_channel edit_bookmark_private_channel use_group_mentions order_bookmark_private_channel read_private_channel_groups delete_bookmark_public_channel upload_file add_reaction edit_bookmark_public_channel delete_bookmark_private_channel use_channel_mentions create_post read_public_channel_groups read_channel_content remove_reaction read_channel add_bookmark_private_channel add_bookmark_public_channel edit_post delete_post get_public_link',
    custom_group_user: '',
    playbook_admin: 'playbook_private_manage_roles playbook_private_manage_properties playbook_public_make_private playbook_public_manage_members playbook_public_manage_roles playbook_public_manage_properties playbook_private_manage_members',
    playbook_member: 'playbook_public_manage_properties playbook_private_view playbook_private_manage_members playbook_private_manage_properties run_create playbook_public_view playbook_public_manage_members',
    run_admin: 'run_manage_properties run_manage_members',
    run_member: 'run_view',
    system_admin: 'edit_bookmark_public_channel sysconsole_write_authentication_mfa sysconsole_read_site_notices test_s3 sysconsole_write_site_notifications sysconsole_write_experimental_bleve import_team sysconsole_write_environment_image_proxy manage_custom_group_members add_bookmark_public_channel sysconsole_write_site_announcement_banner invite_user playbook_private_make_public read_compliance_export_job revoke_user_access_token sysconsole_write_user_management_teams sysconsole_read_site_file_sharing_and_downloads sysconsole_write_integrations_bot_accounts read_bots sysconsole_read_reporting_site_statistics sysconsole_write_compliance_compliance_export sysconsole_read_integrations_cors manage_incoming_webhooks manage_channel_roles sysconsole_write_site_emoji manage_system create_user_access_token sysconsole_write_user_management_system_roles delete_others_posts get_saml_cert_status edit_bookmark_private_channel sysconsole_read_authentication_ldap manage_oauth create_compliance_export_job list_public_teams sysconsole_write_compliance_custom_terms_of_service manage_secure_connections sysconsole_read_site_localization read_private_channel_groups sysconsole_read_user_management_permissions sysconsole_read_site_ip_filters run_view add_private_channel_members delete_bookmark_public_channel convert_public_channel_to_private edit_other_users sysconsole_read_authentication_signup read_public_channel_groups manage_public_channel_properties sysconsole_write_integrations_cors manage_ldap_sync_job sysconsole_write_plugins sysconsole_write_experimental_feature_flags sysconsole_read_authentication_openid sysconsole_read_compliance_data_retention_policy read_user_access_token assign_bot playbook_public_manage_properties sysconsole_read_integrations_integration_management playbook_public_manage_roles sysconsole_write_authentication_email sysconsole_read_environment_push_notification_server manage_roles create_custom_group sysconsole_read_environment_performance_monitoring sysconsole_write_compliance_data_retention_policy manage_post_bleve_indexes_job sysconsole_read_authentication_saml create_ldap_sync_job sysconsole_write_site_localization manage_others_bots sysconsole_read_experimental_bleve sysconsole_write_environment_web_server sysconsole_read_site_announcement_banner recycle_database_connections manage_team sysconsole_write_environment_high_availability remove_reaction get_saml_metadata_from_idp remove_user_from_team sysconsole_write_reporting_server_logs sysconsole_read_reporting_team_statistics test_ldap create_private_channel add_bookmark_private_channel sysconsole_write_billing view_members sysconsole_write_authentication_password sysconsole_read_site_users_and_teams edit_brand test_elasticsearch read_elasticsearch_post_indexing_job delete_others_emojis sysconsole_write_authentication_openid sysconsole_read_integrations_bot_accounts sysconsole_write_integrations_gif reload_config sysconsole_write_about_edition_and_license sysconsole_write_user_management_users sysconsole_read_environment_high_availability sysconsole_write_authentication_guest_access test_email read_jobs delete_bookmark_private_channel order_bookmark_private_channel sysconsole_write_site_posts sysconsole_write_environment_developer use_group_mentions sysconsole_write_environment_session_lengths sysconsole_write_user_management_channels sysconsole_read_authentication_mfa sysconsole_write_environment_database create_data_retention_job read_channel add_saml_public_cert invite_guest add_saml_private_cert sysconsole_read_authentication_email create_elasticsearch_post_indexing_job test_site_url join_private_teams sysconsole_write_site_notices sysconsole_read_environment_session_lengths purge_bleve_indexes sysconsole_write_environment_push_notification_server delete_custom_group manage_license_information manage_outgoing_oauth_connections read_channel_content edit_custom_group demote_to_guest manage_data_retention_job remove_saml_public_cert sysconsole_write_site_ip_filters playbook_public_create add_saml_idp_cert invalidate_email_invite playbook_private_view sysconsole_write_user_management_groups sysconsole_read_site_customization sysconsole_read_authentication_password sysconsole_write_experimental_features run_create sysconsole_read_environment_elasticsearch read_elasticsearch_post_aggregation_job run_manage_members sysconsole_read_integrations_gif add_user_to_team sysconsole_write_site_users_and_teams sysconsole_write_environment_rate_limiting sysconsole_write_authentication_ldap run_manage_properties sysconsole_read_about_edition_and_license create_elasticsearch_post_aggregation_job add_reaction promote_guest sysconsole_read_site_posts sysconsole_read_compliance_compliance_monitoring order_bookmark_public_channel sysconsole_read_environment_logging sysconsole_read_user_management_teams view_team create_post_bleve_indexes_job create_post_public sysconsole_read_site_public_links sysconsole_write_integrations_integration_management add_ldap_public_cert sysconsole_write_environment_elasticsearch sysconsole_write_environment_smtp playbook_public_view sysconsole_write_compliance_compliance_monitoring sysconsole_read_reporting_server_logs sysconsole_read_user_management_channels sysconsole_read_products_boards sysconsole_read_user_management_groups sysconsole_write_authentication_saml manage_private_channel_members list_team_channels delete_private_channel remove_ldap_public_cert read_other_users_teams manage_private_channel_properties invalidate_caches sysconsole_write_environment_file_storage playbook_private_manage_roles sysconsole_write_environment_logging manage_elasticsearch_post_aggregation_job delete_public_channel sysconsole_read_site_emoji manage_system_wide_oauth list_private_teams edit_others_posts playbook_private_manage_members read_license_information sysconsole_read_plugins manage_slash_commands get_logs sysconsole_write_reporting_team_statistics create_post_ephemeral sysconsole_read_user_management_system_roles sysconsole_read_compliance_compliance_export manage_compliance_export_job use_slash_commands join_public_channels create_public_channel convert_private_channel_to_public sysconsole_read_environment_web_server playbook_private_manage_properties sysconsole_read_environment_image_proxy sysconsole_write_reporting_site_statistics sysconsole_write_products_boards list_users_without_team remove_others_reactions create_post sysconsole_read_environment_developer sysconsole_read_billing sysconsole_write_authentication_signup sysconsole_read_environment_database manage_elasticsearch_post_indexing_job get_public_link manage_jobs assign_system_admin_role sysconsole_read_environment_rate_limiting create_team use_channel_mentions read_data_retention_job playbook_public_make_private manage_others_outgoing_webhooks sysconsole_write_environment_performance_monitoring upload_file sysconsole_read_environment_smtp sysconsole_write_site_file_sharing_and_downloads delete_post sysconsole_read_environment_file_storage remove_saml_idp_cert download_compliance_export_result manage_public_channel_members add_ldap_private_cert create_direct_channel create_bot create_group_channel sysconsole_read_authentication_guest_access manage_others_incoming_webhooks read_others_bots sysconsole_write_site_public_links manage_others_slash_commands manage_bots manage_team_roles sysconsole_write_site_customization read_ldap_sync_job restore_custom_group playbook_public_manage_members create_emojis sysconsole_read_user_management_users sysconsole_read_site_notifications manage_shared_channels manage_outgoing_webhooks join_public_teams playbook_private_create add_public_channel_members sysconsole_read_experimental_features get_analytics remove_ldap_private_cert delete_emojis read_audits remove_saml_private_cert sysconsole_read_compliance_custom_terms_of_service read_deleted_posts edit_post sysconsole_read_experimental_feature_flags purge_elasticsearch_indexes read_public_channel sysconsole_write_user_management_permissions',
    system_custom_group_admin: 'create_custom_group edit_custom_group delete_custom_group restore_custom_group manage_custom_group_members',
    system_guest: 'create_direct_channel create_group_channel',
    system_manager: 'sysconsole_read_user_management_groups sysconsole_read_authentication_guest_access read_ldap_sync_job manage_private_channel_properties sysconsole_read_plugins manage_team sysconsole_read_site_localization sysconsole_read_environment_performance_monitoring sysconsole_read_site_file_sharing_and_downloads sysconsole_write_environment_file_storage sysconsole_write_site_localization sysconsole_write_environment_high_availability sysconsole_write_integrations_integration_management sysconsole_read_environment_logging sysconsole_write_user_management_teams sysconsole_write_site_posts sysconsole_write_environment_image_proxy sysconsole_read_site_notifications sysconsole_write_environment_smtp create_elasticsearch_post_aggregation_job manage_elasticsearch_post_aggregation_job sysconsole_read_user_management_teams sysconsole_read_environment_database sysconsole_write_site_file_sharing_and_downloads test_ldap sysconsole_read_authentication_openid manage_public_channel_properties sysconsole_write_site_announcement_banner sysconsole_read_integrations_gif sysconsole_read_integrations_bot_accounts sysconsole_write_environment_push_notification_server view_team manage_outgoing_oauth_connections sysconsole_read_integrations_cors sysconsole_read_environment_high_availability join_private_teams sysconsole_write_site_users_and_teams sysconsole_write_environment_web_server sysconsole_read_integrations_integration_management read_elasticsearch_post_aggregation_job sysconsole_write_integrations_gif test_elasticsearch sysconsole_read_environment_elasticsearch sysconsole_write_site_emoji purge_elasticsearch_indexes sysconsole_read_authentication_password read_license_information read_public_channel add_public_channel_members sysconsole_write_integrations_cors sysconsole_read_site_users_and_teams delete_public_channel sysconsole_read_environment_smtp read_elasticsearch_post_indexing_job sysconsole_read_authentication_signup delete_private_channel sysconsole_write_environment_elasticsearch sysconsole_read_site_notices create_elasticsearch_post_indexing_job reload_config sysconsole_write_site_customization sysconsole_read_authentication_saml sysconsole_write_environment_performance_monitoring convert_public_channel_to_private sysconsole_write_integrations_bot_accounts sysconsole_read_site_public_links sysconsole_write_environment_rate_limiting sysconsole_read_site_customization sysconsole_write_user_management_channels add_private_channel_members sysconsole_read_about_edition_and_license recycle_database_connections sysconsole_read_environment_session_lengths remove_user_from_team sysconsole_read_authentication_ldap list_private_teams read_public_channel_groups sysconsole_read_user_management_permissions sysconsole_read_environment_rate_limiting list_public_teams read_private_channel_groups sysconsole_read_environment_web_server sysconsole_write_environment_logging sysconsole_write_site_public_links sysconsole_read_user_management_channels test_s3 test_email sysconsole_read_site_posts sysconsole_read_products_boards sysconsole_write_user_management_permissions sysconsole_write_environment_database get_analytics test_site_url manage_channel_roles sysconsole_read_reporting_team_statistics convert_private_channel_to_public add_user_to_team sysconsole_read_site_announcement_banner manage_team_roles sysconsole_read_authentication_mfa sysconsole_write_products_boards sysconsole_read_environment_image_proxy manage_elasticsearch_post_indexing_job join_public_teams sysconsole_read_reporting_site_statistics manage_public_channel_members read_channel sysconsole_read_site_emoji sysconsole_read_environment_file_storage sysconsole_write_environment_developer edit_brand sysconsole_read_environment_developer sysconsole_read_authentication_email manage_private_channel_members sysconsole_write_environment_session_lengths sysconsole_write_site_notices get_logs sysconsole_write_site_notifications invalidate_caches sysconsole_read_environment_push_notification_server sysconsole_write_user_management_groups sysconsole_read_reporting_server_logs',
    system_post_all: 'use_group_mentions create_post use_channel_mentions',
    system_post_all_public: 'create_post_public use_channel_mentions use_group_mentions',
    system_read_only_admin: 'sysconsole_read_environment_elasticsearch sysconsole_read_authentication_guest_access read_elasticsearch_post_aggregation_job sysconsole_read_authentication_mfa view_team sysconsole_read_site_announcement_banner sysconsole_read_site_file_sharing_and_downloads sysconsole_read_reporting_team_statistics sysconsole_read_experimental_bleve read_ldap_sync_job read_private_channel_groups sysconsole_read_site_localization sysconsole_read_reporting_site_statistics sysconsole_read_site_users_and_teams sysconsole_read_authentication_saml sysconsole_read_environment_file_storage sysconsole_read_environment_database sysconsole_read_environment_performance_monitoring sysconsole_read_environment_push_notification_server sysconsole_read_user_management_users sysconsole_read_authentication_email sysconsole_read_environment_image_proxy sysconsole_read_site_emoji sysconsole_read_integrations_cors sysconsole_read_site_notices sysconsole_read_authentication_password sysconsole_read_site_posts sysconsole_read_environment_logging sysconsole_read_about_edition_and_license sysconsole_read_experimental_feature_flags sysconsole_read_site_customization sysconsole_read_compliance_compliance_export read_other_users_teams sysconsole_read_integrations_bot_accounts sysconsole_read_reporting_server_logs sysconsole_read_integrations_integration_management sysconsole_read_experimental_features sysconsole_read_environment_smtp get_analytics sysconsole_read_site_notifications sysconsole_read_compliance_data_retention_policy test_ldap sysconsole_read_site_public_links sysconsole_read_user_management_channels download_compliance_export_result sysconsole_read_environment_high_availability sysconsole_read_compliance_custom_terms_of_service read_license_information list_private_teams sysconsole_read_integrations_gif sysconsole_read_environment_session_lengths read_channel read_public_channel read_compliance_export_job sysconsole_read_authentication_openid sysconsole_read_authentication_signup sysconsole_read_environment_rate_limiting read_audits list_public_teams sysconsole_read_authentication_ldap read_elasticsearch_post_indexing_job sysconsole_read_products_boards sysconsole_read_compliance_compliance_monitoring sysconsole_read_user_management_teams sysconsole_read_plugins sysconsole_read_user_management_permissions sysconsole_read_environment_developer read_data_retention_job sysconsole_read_environment_web_server read_public_channel_groups get_logs sysconsole_read_user_management_groups',
    system_user: 'create_group_channel join_public_teams view_members create_direct_channel list_public_teams',
    system_user_access_token: 'create_user_access_token read_user_access_token revoke_user_access_token',
    system_user_manager: 'sysconsole_write_user_management_teams sysconsole_write_user_management_channels sysconsole_read_authentication_password manage_team sysconsole_read_user_management_groups add_user_to_team convert_public_channel_to_private remove_user_from_team manage_private_channel_properties manage_public_channel_members sysconsole_read_user_management_permissions add_public_channel_members sysconsole_read_authentication_guest_access read_public_channel_groups sysconsole_read_authentication_email list_public_teams sysconsole_write_user_management_groups sysconsole_read_authentication_mfa test_ldap sysconsole_read_authentication_saml sysconsole_read_user_management_teams read_private_channel_groups manage_channel_roles view_team read_channel join_public_teams read_public_channel sysconsole_read_authentication_signup delete_private_channel manage_team_roles delete_public_channel read_ldap_sync_job sysconsole_read_authentication_openid manage_private_channel_members manage_public_channel_properties add_private_channel_members sysconsole_read_user_management_channels join_private_teams list_private_teams sysconsole_read_authentication_ldap convert_private_channel_to_public',
    system_verified: 'create_direct_channel list_public_teams join_public_teams create_emojis create_team delete_custom_group delete_emojis create_group_channel view_members manage_custom_group_members restore_custom_group edit_custom_group create_custom_group',
    team_admin: 'edit_bookmark_private_channel manage_channel_roles manage_others_incoming_webhooks create_post edit_bookmark_public_channel read_public_channel_groups manage_others_outgoing_webhooks manage_incoming_webhooks manage_team manage_outgoing_webhooks delete_others_posts import_team delete_public_channel manage_private_channel_properties manage_team_roles manage_public_channel_properties manage_private_channel_members order_bookmark_private_channel use_group_mentions manage_others_slash_commands create_private_channel remove_user_from_team delete_bookmark_public_channel read_private_channel_groups use_channel_mentions playbook_public_manage_roles delete_private_channel create_public_channel remove_reaction playbook_private_manage_roles delete_post add_bookmark_private_channel add_reaction add_public_channel_members convert_public_channel_to_private add_private_channel_members order_bookmark_public_channel manage_public_channel_members delete_bookmark_private_channel add_bookmark_public_channel manage_slash_commands',
    team_guest: 'view_team',
    team_moderator: 'import_team manage_channel_roles remove_reaction delete_others_posts manage_outgoing_webhooks read_public_channel_groups add_reaction manage_private_channel_properties manage_others_incoming_webhooks order_bookmark_private_channel add_bookmark_public_channel manage_private_channel_members create_public_channel manage_public_channel_members playbook_private_manage_roles manage_others_outgoing_webhooks add_public_channel_members manage_public_channel_properties order_bookmark_public_channel create_post add_bookmark_private_channel manage_incoming_webhooks edit_bookmark_public_channel delete_bookmark_public_channel remove_user_from_team delete_public_channel delete_private_channel manage_slash_commands convert_public_channel_to_private delete_post use_group_mentions use_channel_mentions create_private_channel delete_bookmark_private_channel playbook_public_manage_roles edit_bookmark_private_channel manage_others_slash_commands add_private_channel_members manage_team read_private_channel_groups',
    team_post_all: 'use_channel_mentions use_group_mentions create_post',
    team_post_all_public: 'use_channel_mentions use_group_mentions create_post_public',
    team_user: 'join_public_channels read_public_channel add_user_to_team list_team_channels playbook_public_create invite_user view_team',
    team_verified: 'playbook_public_create add_user_to_team invite_user join_public_channels view_team list_team_channels playbook_private_create read_public_channel'
};

Cypress.Commands.add('getRoleByName', (name) => {
    return cy.request({
        headers: {'X-Requested-With': 'XMLHttpRequest'},
        url: `/api/v4/roles/name/${name}`,
        method: 'GET',
    }).then((response) => {
        expect(response.status).to.equal(200);
        return cy.wrap({name: response.body});
    });
});

Cypress.Commands.add('apiGetRolesByNames', (names) => {
    return cy.request({
        headers: {'X-Requested-With': 'XMLHttpRequest'},
        url: '/api/v4/roles/names',
        method: 'POST',
        body: names || Object.keys(defaultRolesPermissions),
    }).then((response) => {
        expect(response.status).to.equal(200);
        return cy.wrap({roles: response.body});
    });
});

Cypress.Commands.add('apiPatchRole', (roleID, patch) => {
    return cy.request({
        headers: {'X-Requested-With': 'XMLHttpRequest'},
        url: `/api/v4/roles/${roleID}/patch`,
        method: 'PUT',
        body: patch,
    }).then((response) => {
        expect(response.status).to.equal(200);
        return cy.wrap({role: response.body});
    });
});

Cypress.Commands.add('apiResetRoles', () => {
    cy.apiGetRolesByNames().then(({roles}) => {
        roles.forEach((role) => {
            const permissions = getPermissions(role.name);
            const diff = xor(role.permissions, permissions)?.filter((p) => p?.length);

            if (diff?.length > 0) {
                cy.apiPatchRole(role.id, {permissions});
            }
        });
    });
});

function getPermissions(roleName) {
    const permissions = defaultRolesPermissions[roleName];
    if (!permissions) {
        return [];
    }
    return permissions.split(' ').map((permission) => permission.trim()).filter((permission) => permission !== '');
}
